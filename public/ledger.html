<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ledger - Budget App</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <h1>Ledger</h1>
    <form id="ledger-form">
        <label for="date">Date:</label>
        <input type="date" id="date" name="date" required><br><br>

        <label for="description">Description:</label>
        <input type="text" id="description" name="description" required><br><br>

        <label for="category">Category:</label>
        <input type="text" id="category" name="category" required><br><br>

        <label for="memo">Memo:</label>
        <input type="text" id="memo" name="memo"><br><br>

        <label for="amount">Amount:</label>
        <input type="number" id="amount" name="amount" required><br><br>

        <label for="cleared">Cleared:</label>
        <input type="checkbox" id="cleared" name="cleared"><br><br>

        <button type="submit">Add Transaction</button>
    </form>

    <h2>Import OFX File</h2>
    <form id="import-form" enctype="multipart/form-data">
        <input type="file" id="ofx-file" name="ofx-file" accept=".ofx" required>
        <button type="submit">Import</button>
    </form>

    <h2>Transactions</h2>
    <div>
        <button id="sort-date">Sort by Date</button>
        <button id="sort-amount">Sort by Amount</button>
    </div>
    <div id="transactions"></div>
    <button id="prev-page">Previous</button>
    <button id="next-page">Next</button>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <label for="edit-date">Date:</label>
                <input type="date" id="edit-date" name="date" required><br><br>

                <label for="edit-description">Description:</label>
                <input type="text" id="edit-description" name="description" required><br><br>

                <label for="edit-category">Category:</label>
                <input type="text" id="edit-category" name="category" required><br><br>

                <label for="edit-memo">Memo:</label>
                <input type="text" id="edit-memo" name="memo"><br><br>

                <label for="edit-amount">Amount:</label>
                <input type="number" id="edit-amount" name="amount" required><br><br>

                <label for="edit-cleared">Cleared:</label>
                <input type="checkbox" id="edit-cleared" name="cleared"><br><br>

                <button type="submit">Update Transaction</button>
            </form>
        </div>
    </div>

    <script>
        document.getElementById('ledger-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.cleared = formData.has('cleared');

            const response = await fetch('/api/ledger', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert('Transaction added successfully');
                loadTransactions();
            } else {
                alert('Error adding transaction');
            }
        });

        document.getElementById('import-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const response = await fetch('/api/ledger/import', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert('OFX file imported successfully');
                loadTransactions();
            } else {
                alert('Error importing OFX file');
            }
        });

        let currentPage = 1;
        let sortField = 'date';
        let sortDirection = 'asc';

        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadTransactions();
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            currentPage++;
            loadTransactions();
        });

        document.getElementById('sort-date').addEventListener('click', () => {
            sortField = 'date';
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            loadTransactions();
        });

        document.getElementById('sort-amount').addEventListener('click', () => {
            sortField = 'amount';
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            loadTransactions();
        });

        async function loadTransactions() {
            const response = await fetch(`/api/ledger?page=${currentPage}&sortField=${sortField}&sortDirection=${sortDirection}`);
            const result = await response.json();

            const transactionsDiv = document.getElementById('transactions');
            transactionsDiv.innerHTML = '';

            result.transactions.forEach(transaction => {
                const transactionElement = document.createElement('div');
                transactionElement.className = 'transaction';
                transactionElement.innerHTML = `
                    <div>${new Date(transaction.date).toLocaleDateString()}</div>
                    <div>${transaction.description}</div>
                    <div>${transaction.category ? transaction.category : '<b>Needs Category</b>'}</div>
                    <div>${transaction.memo}</div>
                    <div>${transaction.amount}</div>
                    <div>${transaction.cleared ? 'Cleared' : 'Not Cleared'}</div>
                    <button onclick="editTransaction(${transaction.id})">Edit</button>
                `;
                transactionsDiv.appendChild(transactionElement);
            });
        }

        async function editTransaction(id) {
            const response = await fetch(`/api/ledger/${id}`);
            const transaction = await response.json();

            document.getElementById('edit-id').value = transaction.id;
            document.getElementById('edit-date').value = new Date(transaction.date).toISOString().split('T')[0];
            document.getElementById('edit-description').value = transaction.description;
            document.getElementById('edit-category').value = transaction.category;
            document.getElementById('edit-memo').value = transaction.memo;
            document.getElementById('edit-amount').value = transaction.amount;
            document.getElementById('edit-cleared').checked = transaction.cleared;

            document.getElementById('edit-modal').style.display = 'block';
        }

        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.cleared = formData.has('cleared');

            const response = await fetch(`/api/ledger/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert('Transaction updated successfully');
                loadTransactions();
                document.getElementById('edit-modal').style.display = 'none';
            } else {
                alert('Error updating transaction');
            }
        });

        // Close the modal
        document.querySelector('.close').addEventListener('click', () => {
            document.getElementById('edit-modal').style.display = 'none';
        });

        window.onclick = function (event) {
            const modal = document.getElementById('edit-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

        // Load current month's transactions by default
        async function loadCurrentMonthTransactions() {
            const now = new Date();
            currentPage = 1;
            const response = await fetch(`/api/ledger?year=${now.getFullYear()}&month=${now.getMonth() + 1}&page=${currentPage}&sortField=${sortField}&sortDirection=${sortDirection}`);
            const result = await response.json();

            const transactionsDiv = document.getElementById('transactions');
            transactionsDiv.innerHTML = '';

            result.transactions.forEach(transaction => {
                const transactionElement = document.createElement('div');
                transactionElement.className = 'transaction';
                transactionElement.innerHTML = `
                    <div>${new Date(transaction.date).toLocaleDateString()}</div>
                    <div>${transaction.description}</div>
                    <div>${transaction.category ? transaction.category : '<b>Needs Category</b>'}</div>
                    <div>${transaction.memo}</div>
                    <div>${transaction.amount}</div>
                    <div>${transaction.cleared ? 'Cleared' : 'Not Cleared'}</div>
                    <button onclick="editTransaction(${transaction.id})">Edit</button>
                `;
                transactionsDiv.appendChild(transactionElement);
            });
        }

        document.addEventListener('DOMContentLoaded', loadCurrentMonthTransactions);
    </script>
</body>

</html>